#!/bin/sh
#sudo mcedit /etc/mosquitto/conf.d/mqtt.conf
# mosquitto_sub -v -t rpi_home/dashboard/feed/update
# mosquitto_sub -v -t rpi_home/dashboard/stream/create

mosquitto_sub -h io.adafruit.com -p 1883 -u rpi_home -P `cat ~/.AIO_KEY` -t rpi_home/dashboard/stream/create -R | while read json ; do
echo "$json" > ~/mqtt.json
message=`cat ~/mqtt.json | jq --raw-output 'select(.value != null).value'`
feed==`cat ~/mqtt.json | jq --raw-output 'select(.value != null).feed_id'`
echo $message
echo $feed

case $message in
  play)
    wall "debut de start now"
    tmux send -t cast.1 'cd ~/scripts && clear' ENTER
    tmux send -t cast.1 'bash castnow-start' ENTER
    tmux select-window -t pi:cast
    tmux select-pane -t cast.1
    wall "(((((((((((((((((((((((((("
    tmux attach -t pi;;
  
  stop)
    wall "debut de start now"
    tmux send -t cast.1 'cd ~/scripts && clear' ENTER
    #tmux send-keys -t cast.1 C-r
    tmux send -t cast.1 'bash castnow-stop' ENTER
    tmux select-window -t pi:cast
    tmux select-pane -t cast.1
    wall "(((((((((((((((((((((((((("
    tmux attach -t pi;;
 
 merge)
    wall "debut de merge now"
    tmux send -t cloud.1 'cd ~/scripts && clear' ENTER
    #tmux send-keys -t cloud.1 C-r
    tmux send -t cloud.1 'bash merge-pdf' ENTER
    tmux select-window -t pi:cloud
    tmux select-pane -t cloud.1
    wall "(((((((((((((((((((((((((("
    tmux attach -t pi;;

*) ;;
esac
done

case $feed
  =635172)
    echo "---------------"
    echo $message
    echo "---------------"
    ;;
  esac
done
