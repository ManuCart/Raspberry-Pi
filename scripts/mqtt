#!/bin/bash
clean="output input cmds";p="backpipe";pid=$(cat pidfile)
ctrl_c() {
  echo "Cleaning up..."
  rm -f $p;rm "$clean";kill $pid 2>/dev/null
  if [[ "$?" -eq "0" ]];
  then
     echo "Exit success";exit 0
  else
     exit 1
  fi
}

listen(){
([ ! -p "$p" ]) && mkfifo $p
(mosquitto_sub -h mqtt.devicehub.net -p 1883 -t "/a/03f761ae-7314-4b2f-a2d5-37bbba6708c2/p/6883/d/6c8946b9-576d-4fbb-ae0e-4165394d78c5/#" >$
echo "$!" > pidfile
while read line <$p
do
  echo $line > cmds
  if grep -q "quit" cmds; then
    (rm -f $p;rm $clean;kill $pid) 2>/dev/null
    break
  else
    echo $line
  fi
done
}

trap ctrl_c INT
listen
;;
esac
