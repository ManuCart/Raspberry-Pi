#
#Init

GDRIVE=/media/hdd/Drive
FILE=/home/pi/IFTTT.csv

cd $GDRIVE
if ! drive pull --no-prompt --export csv --force --exports-dir /tmp --same-exports-dir IFTTT ; then 
    ~/scripts/iftt-maker "MQTT" "Error pull" ; exit
fi
tr -d '\r' < /tmp/IFTTT.csv > $FILE
#Download
dropbox_uploader download IFTTT /home/pi


while IFS=, read email in out
do
    echo "I got:|$email|$in|$out|"
    rm ~/files.csv
    if [[ -n $(find /home/pi/IFTTT -name "$in") ]]
        then
        find /home/pi/IFTTT -name "$in" | tr '\n' ',' > ~/files.csv
        echo "/home/pi/IFTTT/$out" >> ~/files.csv
        cat ~/files.csv
        cd $GDRIVE
        if ! drive pull --no-prompt "Documents/$out" ; then ~/scripts/iftt-maker "Auto Merge PDF" "Error pull ref doc" ; exit; fi
        cp "Documents/$out" "/home/pi/IFTTT/$out"
        if grep -r "Encrypt" /home/pi/IFTTT ; then ~/scripts/iftt-maker "Auto Merge PDF" "ERROR CRYPTED FILE"; exit; fi
        ~/.bin/sejda/bin/sejda-console merge -l ~/files.csv -o sejda_out.pdf
        mv sejda_out.pdf "Documents/$out"
        if ! drive push --no-prompt "Documents/$out" ; then ~/scripts/iftt-maker "Auto Merge PDF" "Error push ref doc" ; exit; fi
    fi
done < "$FILE"

dropbox_uploader delete IFTTT
